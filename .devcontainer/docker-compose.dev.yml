#Compose Stack Name
name: Dev_Arka_Project


services:
  db:
    image: mysql:8.4
    mem_limit: 1420m
    container_name: MySQL_Arka
    env_file:
      - ./.env.db
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_0900_ai_ci
    ports:
      - "3306:3306"
    volumes:
      - mysqldata:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u $$MYSQL_USER --password=$$MYSQL_PASSWORD || exit 1"] # -> Ping
      interval: 20s # -> Lapso de Ejecucion
      timeout: 10s 
      retries: 2
      start_period : 20s
    networks:
      - Data-Back
      - Data-DataManager

  db-init:  
    image: mysql:8.4  
    container_name: MYSQLInit
    env_file:  
      - ./.env.db  
    depends_on:  
      db:  
        condition: service_healthy  
    entrypoint: sh -c "mysql -hdb -uroot -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE < /init.sql"  
    volumes:  
      - ./init.sql:/init.sql  
    networks:  
      - Data-Back

  phpmyadmin: 
    container_name: PHPMyAdmin_Arka_Dev
    image: phpmyadmin:5.2.3-apache
    mem_limit: 1420m
    ports:  
      - "127.0.0.1:749:80" 
    environment:  
      - PMA_HOST=db # nombre del servicio MySQL en el Docker-Compose -> resolucion de host
      - PMA_PORT=3306
    depends_on:  
      db:
        condition : service_healthy
    networks:
      - Data-DataManager

  backend:  
    build:  
      context: ../Backend  
      dockerfile: Dockerfile.dev
    mem_limit: 6420m
    #network_mode: host # -> Means container will use the host network || TODO -> Solve DockerNetworkIssue
    container_name: Backend_Arka
    working_dir: /workspace
    # DEPRECATED -> command: bash -lc "./gradlew bootRun --continuous"  
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./.env.back
    ports:  
      - "900:8080"   # host:container  \PORTS
    volumes:  
      # El workspace para este servicio lo monta autom√°ticamente devcontainer  
      - gradle-cache:/home/vscode/.gradle
      - ../Backend/src:/workspace
    init: true
    stdin_open: true
    tty: true
    # security_opt:
    #   - no-new-privileges:true
    networks:
      - Data-Back
      - Front-Back

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile.dev
    mem_limit: 2420m
    env_file:
      - ./.env.front
    container_name: Frontend_Arka
    volumes:
      - ../frontend:/app
    working_dir: /app
    init: true
    tty: true
    stdin_open: true
    depends_on:
      - backend
    ports:
      - "3000:3000"
    networks:
      - Front-Back
  #   security_opt:
  #      - no-new-privileges:true
    
volumes:
  mysqldata:
  gradle-cache:

networks:
  Data-Back:
    driver: bridge
    enable_ipv6: false
  Front-Back:
    driver: bridge
    enable_ipv6: false
  Data-DataManager:
    driver: bridge

# Enable ipv6 is an scar, result of the war against DockerNetworkIssue