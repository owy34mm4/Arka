#Compose Stack Name
name: Dev_Arka_Project


services:
  db:
    image: mysql:8.4
    mem_limit: 1g
    cpus: "0.5"
    container_name: MySQL_Arka
    env_file:
      - ./.env.db
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_0900_ai_ci
    ports:
      - "127.0.0.1:3306:3306" #PortBinding -> ExposicionHost : PuertoContenedorAExponer
    volumes:
      - mysqldata:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u $$MYSQL_USER --password=$$MYSQL_PASSWORD || exit 1"] # -> Ping
      interval: 20s # -> Lapso de Ejecucion
      timeout: 10s 
      retries: 2
      start_period : 20s
    networks:
      - Data-Back
      - Data-DataManager
      - Data-DataInit

  db-init:  
    image: mysql:8.4  
    container_name: MYSQLInit
    env_file:  
      - ./.env.db  
    depends_on:  
      db:  
        condition: service_healthy  
    entrypoint: sh -c "mysql -hdb -uroot -p$$MYSQL_ROOT_PASSWORD $$MYSQL_DATABASE < /init.sql"  
    volumes:  
      - ./init.sql:/init.sql  
    networks:  
      - Data-DataInit

  phpmyadmin: 
    container_name: PHPMyAdmin_Arka_Dev
    image: phpmyadmin:5.2.3-apache
    mem_limit: 1g
    cpus: "0.5"
    ports:  
      - "127.0.0.1:749:80" 
    environment:  
      - PMA_HOST=db # nombre del servicio MySQL en el Docker-Compose -> resolucion de host
      - PMA_PORT=3306
    depends_on:  
      db:
        condition : service_healthy
    networks:
      - Data-DataManager

  backend:  
    build:  
      context: ../Backend  
      dockerfile: Dockerfile.dev
    mem_limit: 6g
    cpus: "6"
    #network_mode: host # -> Means container will use the host network || DID -> Solve DockerNetworkIssue
    container_name: Backend_Arka
    working_dir: /workspace
    #Deprecated due to ->dockerfile< ENTRYPOINT [] > -> command: bash -lc "./gradlew bootstrap:bootRun --continuous"  
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./.env.back
    ports:  
      - "900:8080"   # host:container  \PORTS
    volumes:  
      # El workspace para este servicio lo monta automÃ¡ticamente devcontainer  
      - gradle-cache:/home/vscode/.gradle
      - ../Backend/src:/workspace
    healthcheck:
      test: ["CMD", "curl localhost:8080/api/v0/healthcheck"] # -> Ping
      interval: 20s # -> Lapso de Ejecucion
      timeout: 10s 
      retries: 2
      start_period : 20s
    # security_opt:
    #   - no-new-privileges:true
    networks:
      - Data-Back
      - Back-BackAuth

  backend_auth:
    build: 
      context: ../arka-auth
      dockerfile: Dockerfile.dev
    mem_limit: 4g
    cpus: "3"
    working_dir: /workspace
    container_name: Arka-Auth-Service
    #depends_on:
    #  backend:
    #    condition : service_healthy
    ports:
      - "901:8080"
    volumes:
      - ../arka-auth/src:/workspace
    networks:
      - Back-BackAuth


volumes:
  mysqldata:
  gradle-cache:

networks:
  Data-Back:
    driver: bridge
    enable_ipv6: false
  Data-DataInit:
    driver : bridge
  Data-DataManager:
    driver: bridge
  Back-BackAuth:
    driver: bridge

# Enable ipv6 is an scar, result of the war against DockerNetworkIssue